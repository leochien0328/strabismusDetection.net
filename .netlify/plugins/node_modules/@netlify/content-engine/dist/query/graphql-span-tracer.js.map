{"version":3,"file":"graphql-span-tracer.js","names":["_reporter","_interopRequireDefault","require","_utils","GraphQLSpanTracer","constructor","name","activityArgs","parentActivity","report","phantomActivity","activities","Map","getParentActivity","start","end","forEach","activity","createResolverActivity","path","prev","_prev","key","parentSpan","getActivity","span","tags","field","pathToArray","join","setActivity","gqlPath","length","get","set","exports","default"],"sources":["../../src/query/graphql-span-tracer.ts"],"sourcesContent":["import { Path } from \"graphql/jsutils/Path\";\n\nimport report from \"../reporter\";\nimport { IActivityArgs } from \"../reporter/reporter\";\nimport { IPhantomReporter } from \"../reporter/reporter-phantom\";\n\nimport { IGraphQLSpanTracer } from \"../schema/type-definitions\";\nimport { pathToArray } from \"./utils\";\n\n/**\n * Tracks and knows how to get a parent span for a particular\n *  point in query resolver for a particular query and path\n */\nexport default class GraphQLSpanTracer implements IGraphQLSpanTracer {\n  parentActivity: IPhantomReporter;\n  activities: Map<string, IPhantomReporter>;\n\n  constructor(name: string, activityArgs: IActivityArgs) {\n    this.parentActivity = report.phantomActivity(\n      name,\n      activityArgs,\n    ) as IPhantomReporter;\n    this.activities = new Map();\n  }\n\n  getParentActivity(): IPhantomReporter {\n    return this.parentActivity;\n  }\n\n  start(): void {\n    this.parentActivity.start();\n  }\n\n  end(): void {\n    this.activities.forEach((activity) => {\n      activity.end();\n    });\n    this.parentActivity.end();\n  }\n\n  createResolverActivity(path: Path, name: string): IPhantomReporter {\n    let prev: Path | undefined = path.prev;\n    while (typeof prev?.key === `number`) {\n      prev = prev.prev;\n    }\n    const parentSpan = this.getActivity(prev).span;\n    const activity = report.phantomActivity(`GraphQL Resolver`, {\n      parentSpan,\n      tags: {\n        field: name,\n        path: pathToArray(path).join(`.`),\n      },\n    });\n    this.setActivity(path, activity);\n    return activity;\n  }\n\n  getActivity(gqlPath: Path | undefined): IPhantomReporter {\n    const path = pathToArray(gqlPath);\n    let activity;\n    if (path.length > 0) {\n      activity = this.activities.get(path.join(`.`));\n      if (activity) {\n        return activity;\n      }\n    }\n\n    return this.parentActivity;\n  }\n\n  setActivity(gqlPath: Path, activity: IPhantomReporter): void {\n    const path = pathToArray(gqlPath);\n    this.activities.set(path.join(`.`), activity);\n  }\n}\n"],"mappings":";;;;;AAEA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AAKA,IAAAC,MAAA,GAAAD,OAAA;AAEA;AACA;AACA;AACA;AACe,MAAME,iBAAiB,CAA+B;EAInEC,WAAWA,CAACC,IAAY,EAAEC,YAA2B,EAAE;IACrD,IAAI,CAACC,cAAc,GAAGC,iBAAM,CAACC,eAAe,CAC1CJ,IAAI,EACJC,YACF,CAAqB;IACrB,IAAI,CAACI,UAAU,GAAG,IAAIC,GAAG,CAAC,CAAC;EAC7B;EAEAC,iBAAiBA,CAAA,EAAqB;IACpC,OAAO,IAAI,CAACL,cAAc;EAC5B;EAEAM,KAAKA,CAAA,EAAS;IACZ,IAAI,CAACN,cAAc,CAACM,KAAK,CAAC,CAAC;EAC7B;EAEAC,GAAGA,CAAA,EAAS;IACV,IAAI,CAACJ,UAAU,CAACK,OAAO,CAAEC,QAAQ,IAAK;MACpCA,QAAQ,CAACF,GAAG,CAAC,CAAC;IAChB,CAAC,CAAC;IACF,IAAI,CAACP,cAAc,CAACO,GAAG,CAAC,CAAC;EAC3B;EAEAG,sBAAsBA,CAACC,IAAU,EAAEb,IAAY,EAAoB;IACjE,IAAIc,IAAsB,GAAGD,IAAI,CAACC,IAAI;IACtC,OAAO,SAAAC,KAAA,GAAOD,IAAI,cAAAC,KAAA,uBAAJA,KAAA,CAAMC,GAAG,MAAM,QAAO,EAAE;MAAA,IAAAD,KAAA;MACpCD,IAAI,GAAGA,IAAI,CAACA,IAAI;IAClB;IACA,MAAMG,UAAU,GAAG,IAAI,CAACC,WAAW,CAACJ,IAAI,CAAC,CAACK,IAAI;IAC9C,MAAMR,QAAQ,GAAGR,iBAAM,CAACC,eAAe,CAAE,kBAAiB,EAAE;MAC1Da,UAAU;MACVG,IAAI,EAAE;QACJC,KAAK,EAAErB,IAAI;QACXa,IAAI,EAAE,IAAAS,kBAAW,EAACT,IAAI,CAAC,CAACU,IAAI,CAAE,GAAE;MAClC;IACF,CAAC,CAAC;IACF,IAAI,CAACC,WAAW,CAACX,IAAI,EAAEF,QAAQ,CAAC;IAChC,OAAOA,QAAQ;EACjB;EAEAO,WAAWA,CAACO,OAAyB,EAAoB;IACvD,MAAMZ,IAAI,GAAG,IAAAS,kBAAW,EAACG,OAAO,CAAC;IACjC,IAAId,QAAQ;IACZ,IAAIE,IAAI,CAACa,MAAM,GAAG,CAAC,EAAE;MACnBf,QAAQ,GAAG,IAAI,CAACN,UAAU,CAACsB,GAAG,CAACd,IAAI,CAACU,IAAI,CAAE,GAAE,CAAC,CAAC;MAC9C,IAAIZ,QAAQ,EAAE;QACZ,OAAOA,QAAQ;MACjB;IACF;IAEA,OAAO,IAAI,CAACT,cAAc;EAC5B;EAEAsB,WAAWA,CAACC,OAAa,EAAEd,QAA0B,EAAQ;IAC3D,MAAME,IAAI,GAAG,IAAAS,kBAAW,EAACG,OAAO,CAAC;IACjC,IAAI,CAACpB,UAAU,CAACuB,GAAG,CAACf,IAAI,CAACU,IAAI,CAAE,GAAE,CAAC,EAAEZ,QAAQ,CAAC;EAC/C;AACF;AAACkB,OAAA,CAAAC,OAAA,GAAAhC,iBAAA"}