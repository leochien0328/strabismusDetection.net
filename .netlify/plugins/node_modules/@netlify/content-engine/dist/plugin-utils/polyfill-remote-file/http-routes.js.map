{"version":3,"file":"http-routes.js","names":["_path","_interopRequireDefault","require","_fsExtra","_fetchRemoteFile","_hasFeature","_urlGenerator","_mimeTypeHelpers","_transformImages","_getRequestHeadersForUrl","polyfillImageServiceDevRoutes","app","store","hasFeature","addImageRoutes","get","req","res","_global$__GATSBY","outputDir","path","join","global","__GATSBY","root","process","cwd","url","query","ImageCDNUrlKeys","URL","filePath","fetchRemoteFile","directory","name","params","filename","httpHeaders","getRequestHeadersForUrl","fs","createReadStream","pipe","_global$__GATSBY2","remoteUrl","decodeURIComponent","searchParams","URLSearchParams","ARGS","resizeParams","width","height","quality","format","key","value","Number","transformImage","args","setHeader","getFileExtensionFromMimeType","extname"],"sources":["../../../src/plugin-utils/polyfill-remote-file/http-routes.ts"],"sourcesContent":["import path from \"path\";\nimport fs from \"fs-extra\";\nimport { fetchRemoteFile } from \"../../core-utils/fetch-remote-file\";\nimport { hasFeature } from \"../has-feature\";\nimport { ImageCDNUrlKeys } from \"./utils/url-generator\";\nimport { getFileExtensionFromMimeType } from \"./utils/mime-type-helpers\";\nimport { transformImage } from \"./transform-images\";\nimport { getRequestHeadersForUrl } from \"./utils/get-request-headers-for-url\";\n\nimport type { Application } from \"express\";\nimport type { Store } from \"../../types\";\n\nexport function polyfillImageServiceDevRoutes(\n  app: Application,\n  store?: Store,\n): void {\n  if (hasFeature(`image-cdn`)) {\n    return;\n  }\n\n  addImageRoutes(app, store);\n}\n\nexport function addImageRoutes(app: Application, store?: Store): Application {\n  app.get(`/_gatsby/file/:url/:filename`, async (req, res) => {\n    const outputDir = path.join(\n      global.__GATSBY?.root || process.cwd(),\n      `public`,\n      `_gatsby`,\n      `file`,\n    );\n\n    const url = req.query[ImageCDNUrlKeys.URL] as string;\n\n    const filePath = await fetchRemoteFile({\n      directory: outputDir,\n      url,\n      name: req.params.filename,\n      httpHeaders: getRequestHeadersForUrl(url, store),\n    });\n\n    fs.createReadStream(filePath).pipe(res);\n  });\n\n  app.get(`/_gatsby/image/:url/:params/:filename`, async (req, res) => {\n    const { url, params, filename } = req.params;\n    const remoteUrl = decodeURIComponent(\n      req.query[ImageCDNUrlKeys.URL] as string,\n    );\n    const searchParams = new URLSearchParams(\n      decodeURIComponent(req.query[ImageCDNUrlKeys.ARGS] as string),\n    );\n\n    const resizeParams: {\n      width: number;\n      height: number;\n      quality: number;\n      format: string;\n    } = {\n      width: 0,\n      height: 0,\n      quality: 75,\n      format: ``,\n    };\n\n    for (const [key, value] of searchParams) {\n      switch (key) {\n        case `w`: {\n          resizeParams.width = Number(value);\n          break;\n        }\n        case `h`: {\n          resizeParams.height = Number(value);\n          break;\n        }\n        case `fm`: {\n          resizeParams.format = value;\n          break;\n        }\n        case `q`: {\n          resizeParams.quality = Number(value);\n          break;\n        }\n      }\n    }\n\n    const outputDir = path.join(\n      global.__GATSBY?.root || process.cwd(),\n      `public`,\n      `_gatsby`,\n      `_image`,\n      url,\n      params,\n    );\n\n    const httpHeaders = getRequestHeadersForUrl(remoteUrl, store) as\n      | Record<string, string>\n      | undefined;\n\n    const filePath = await transformImage({\n      outputDir,\n      args: {\n        url: remoteUrl,\n        filename,\n        httpHeaders,\n        ...resizeParams,\n      },\n    });\n\n    res.setHeader(\n      `content-type`,\n      getFileExtensionFromMimeType(path.extname(filename)),\n    );\n\n    fs.createReadStream(filePath).pipe(res);\n  });\n\n  return app;\n}\n"],"mappings":"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"}