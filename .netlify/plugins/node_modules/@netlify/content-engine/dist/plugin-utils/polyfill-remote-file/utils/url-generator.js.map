{"version":3,"file":"url-generator.js","names":["_crypto","_interopRequireDefault","require","_path","_url","_createContentDigest","_types","ORIGIN","ImageCDNUrlKeys","exports","encryptImageCdnUrl","secretKey","iv","urlToEncrypt","randomPadding","crypto","randomBytes","randomInt","toString","toEncrypt","cipher","createCipheriv","Buffer","from","encrypted","update","finalBuffer","concat","final","appendUrlParamToSearchParams","searchParams","url","key","process","env","IMAGE_CDN_ENCRYPTION_SECRET_KEY","IMAGE_CDN_ENCRYPTION_IV","shouldEncrypt","paramName","ENCRYPTED_URL","URL","finalUrl","append","generateFileUrl","filename","store","fileExt","extname","filenameWithoutExt","basename","parsedURL","generatePublicUrl","pathname","search","generateImageUrl","source","imageArgs","queryStr","generateImageArgs","createContentDigest","format","ARGS","CONTENT_DIGEST","internal","contentDigest","mimeType","_state$program","_state$config","state","getState","pathPrefix","program","prefixPaths","config","remoteUrl","publicUrl","isImage","width","height","cropFocus","quality","args","push","Array","isArray","join"],"sources":["../../../../src/plugin-utils/polyfill-remote-file/utils/url-generator.ts"],"sourcesContent":["import crypto from \"crypto\";\nimport { basename, extname } from \"path\";\nimport { URL } from \"url\";\nimport { createContentDigest } from \"../../../core-utils/create-content-digest\";\nimport { isImage } from \"../types\";\nimport type { ImageCropFocus, WidthOrHeight } from \"../types\";\nimport type { Store } from \"../../../types\";\n\n// this is an arbitrary origin that we use #branding so we can construct a full url for the URL constructor\nconst ORIGIN = `https://gatsbyjs.com`;\n\nexport enum ImageCDNUrlKeys {\n  URL = `u`,\n  ENCRYPTED_URL = `eu`,\n  ARGS = `a`,\n  CONTENT_DIGEST = `cd`,\n}\n\nfunction encryptImageCdnUrl(\n  secretKey: string,\n  iv: string,\n  urlToEncrypt: string,\n): string {\n  const randomPadding = crypto\n    .randomBytes(crypto.randomInt(32, 64))\n    .toString(`hex`);\n\n  const toEncrypt = `${randomPadding}:${urlToEncrypt}`;\n  const cipher = crypto.createCipheriv(\n    `aes-256-ctr`,\n    Buffer.from(secretKey, `hex`),\n    Buffer.from(iv, `hex`),\n  );\n  const encrypted = cipher.update(toEncrypt);\n  const finalBuffer = Buffer.concat([encrypted, cipher.final()]);\n\n  return finalBuffer.toString(`hex`);\n}\n\nfunction appendUrlParamToSearchParams(\n  searchParams: URLSearchParams,\n  url: string,\n): void {\n  const key = process.env.IMAGE_CDN_ENCRYPTION_SECRET_KEY || ``;\n  const iv = process.env.IMAGE_CDN_ENCRYPTION_IV || ``;\n  const shouldEncrypt = !!(iv && key);\n\n  const paramName = shouldEncrypt\n    ? ImageCDNUrlKeys.ENCRYPTED_URL\n    : ImageCDNUrlKeys.URL;\n\n  const finalUrl = shouldEncrypt ? encryptImageCdnUrl(key, iv, url) : url;\n\n  searchParams.append(paramName, finalUrl);\n}\n\nexport function generateFileUrl(\n  {\n    url,\n    filename,\n  }: {\n    url: string;\n    filename: string;\n  },\n  store?: Store,\n): string {\n  const fileExt = extname(filename);\n  const filenameWithoutExt = basename(filename, fileExt);\n\n  const parsedURL = new URL(\n    `${ORIGIN}${generatePublicUrl(\n      {\n        url,\n      },\n      store,\n    )}/${filenameWithoutExt}${fileExt}`,\n  );\n\n  appendUrlParamToSearchParams(parsedURL.searchParams, url);\n\n  return `${parsedURL.pathname}${parsedURL.search}`;\n}\n\nexport function generateImageUrl(\n  source: {\n    url: string;\n    mimeType: string;\n    filename: string;\n    internal: { contentDigest: string };\n  },\n  imageArgs: Parameters<typeof generateImageArgs>[0],\n  store?: Store,\n): string {\n  const filenameWithoutExt = basename(\n    source.filename,\n    extname(source.filename),\n  );\n  const queryStr = generateImageArgs(imageArgs);\n\n  const parsedURL = new URL(\n    `${ORIGIN}${generatePublicUrl(source, store)}/${createContentDigest(\n      queryStr,\n    )}/${filenameWithoutExt}.${imageArgs.format}`,\n  );\n\n  appendUrlParamToSearchParams(parsedURL.searchParams, source.url);\n  parsedURL.searchParams.append(ImageCDNUrlKeys.ARGS, queryStr);\n  parsedURL.searchParams.append(\n    ImageCDNUrlKeys.CONTENT_DIGEST,\n    source.internal.contentDigest,\n  );\n\n  return `${parsedURL.pathname}${parsedURL.search}`;\n}\n\nfunction generatePublicUrl(\n  {\n    url,\n    mimeType,\n  }: {\n    url: string;\n    mimeType?: string;\n  },\n  store?: Store,\n): string {\n  const state = store?.getState();\n\n  // @ts-ignore\n  const pathPrefix = state?.program?.prefixPaths\n    ? // @ts-ignore\n      state?.config?.pathPrefix\n    : ``;\n\n  const remoteUrl = createContentDigest(url);\n\n  let publicUrl =\n    pathPrefix +\n    (mimeType && isImage({ mimeType }) ? `/_gatsby/image/` : `/_gatsby/file/`);\n\n  publicUrl += `${remoteUrl}`;\n\n  return publicUrl;\n}\n\nfunction generateImageArgs({\n  width,\n  height,\n  format,\n  cropFocus,\n  quality,\n}: WidthOrHeight & {\n  format: string;\n  cropFocus?: ImageCropFocus | Array<ImageCropFocus>;\n  quality: number;\n}): string {\n  const args: Array<string> = [];\n  if (width) {\n    args.push(`w=${width}`);\n  }\n  if (height) {\n    args.push(`h=${height}`);\n  }\n  if (cropFocus) {\n    args.push(`fit=crop`);\n    args.push(\n      `crop=${Array.isArray(cropFocus) ? cropFocus.join(`,`) : cropFocus}`,\n    );\n  }\n  args.push(`fm=${format}`);\n  args.push(`q=${quality}`);\n\n  return args.join(`&`);\n}\n"],"mappings":"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"}