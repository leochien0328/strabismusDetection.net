{"version":3,"file":"cache.js","names":["_cacheManager","_interopRequireDefault","require","_fsExtra","fsStore","_interopRequireWildcard","_path","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","MAX_CACHE_SIZE","TTL","Number","MAX_SAFE_INTEGER","GatsbyCache","constructor","name","store","_global$__GATSBY$root","_global$__GATSBY","directory","path","join","global","__GATSBY","root","process","cwd","init","fs","ensureDirSync","configs","max","ttl","options","caches","map","manager","caching","multiCaching","Promise","resolve","Error","err","res","undefined","value","args","del","exports"],"sources":["../../src/utils/cache.ts"],"sourcesContent":["import manager, {\n  Store,\n  StoreConfig,\n  CachingConfig,\n  MultiCache,\n} from \"cache-manager\";\nimport fs from \"fs-extra\";\nimport * as fsStore from \"../cache/cache-fs\";\nimport path from \"path\";\n\nconst MAX_CACHE_SIZE = 250;\nconst TTL = Number.MAX_SAFE_INTEGER;\n\ninterface ICacheProperties {\n  name?: string;\n  store?: Store;\n}\n\nexport default class GatsbyCache {\n  public name: string;\n  public store: Store;\n  public directory: string;\n  // TODO: remove `.cache` in v4. This is compat mode - cache-manager cache implementation\n  // expose internal cache that gives access to `.del` function that wasn't available in public\n  // cache interface (gatsby-plugin-sharp use it to clear no longer needed data)\n  public cache?: MultiCache;\n\n  // @ts-ignore - set & get types are missing from fsStore?\n  constructor({ name = `db`, store = fsStore }: ICacheProperties = {}) {\n    this.name = name;\n    this.store = store;\n    this.directory = path.join(\n      global.__GATSBY?.root ?? process.cwd(),\n      `.cache`,\n      `caches`,\n      name,\n    );\n  }\n\n  init(): GatsbyCache {\n    fs.ensureDirSync(this.directory);\n\n    const configs: Array<StoreConfig> = [\n      {\n        store: `memory`,\n        max: MAX_CACHE_SIZE,\n        ttl: TTL,\n      },\n      {\n        store: this.store,\n        ttl: TTL,\n        options: {\n          path: this.directory,\n          ttl: TTL,\n        },\n      },\n    ];\n\n    const caches = configs.map((cache) => manager.caching(cache));\n\n    this.cache = manager.multiCaching(caches);\n\n    return this;\n  }\n\n  async get<T = unknown>(key): Promise<T | undefined> {\n    return new Promise((resolve) => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`,\n        );\n      }\n      this.cache.get<T>(key, (err, res) => {\n        resolve(err ? undefined : res);\n      });\n    });\n  }\n\n  async set<T>(\n    key: string,\n    value: T,\n    args: CachingConfig = { ttl: TTL },\n  ): Promise<T | undefined> {\n    return new Promise((resolve) => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`,\n        );\n      }\n      this.cache.set(key, value, args, (err) => {\n        resolve(err ? undefined : value);\n      });\n    });\n  }\n\n  async del(key: string): Promise<void> {\n    if (!this.cache) {\n      throw new Error(\n        `GatsbyCache wasn't initialised yet, please run the init method first`,\n      );\n    }\n\n    return this.cache.del(key);\n  }\n}\n"],"mappings":"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"}