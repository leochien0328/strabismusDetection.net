{"version":3,"file":"stack-trace-utils.js","names":["_stackTrace","_interopRequireDefault","require","_codeFrame","_traceMapping","fs","path","chalk","isNodeInternalModulePath","getDirName","arg","dirname","contentEngineLocation","resolve","reduxThunkLocation","reduxLocation","getNonGatsbyCallSite","stackTrace","get","find","callSite","getFileName","includes","getNonGatsbyCodeFrame","highlightCode","stack","parse","name","message","fileName","line","getLineNumber","column","getColumnNumber","code","readFileSync","encoding","codeFrame","codeFrameColumns","start","exports","getNonGatsbyCodeFrameFormatted","possibleCodeFrame","bold","findOriginalSourcePositionAndContent","webpackSource","position","_position$column","tracer","TraceMap","sourcePosition","originalPositionFor","source","sourceContent","sourceContentFor"],"sources":["../../src/utils/stack-trace-utils.ts"],"sourcesContent":["import stackTrace, { StackFrame } from \"stack-trace\";\nimport { codeFrameColumns } from \"@babel/code-frame\";\nimport {\n  TraceMap,\n  originalPositionFor,\n  OriginalMapping,\n  SourceMapInput,\n  sourceContentFor,\n} from \"@jridgewell/trace-mapping\";\n\nconst fs = require(`fs-extra`);\nconst path = require(`path`);\nconst chalk = require(`chalk`);\nconst { isNodeInternalModulePath } = require(`../core-utils`);\n\nconst getDirName = (arg: unknown): string => {\n  // Caveat related to executing in engines:\n  // After webpack bundling we would get number here (webpack module id) and that would crash when doing\n  // path.dirname(number).\n  if (typeof arg === `string`) {\n    return path.dirname(arg);\n  }\n  return `-cant-resolve-`;\n};\n\nconst contentEngineLocation = getDirName(require.resolve(`../../package.json`));\nconst reduxThunkLocation = getDirName(\n  require.resolve(`redux-thunk/package.json`),\n);\nconst reduxLocation = getDirName(require.resolve(`redux/package.json`));\n\nconst getNonGatsbyCallSite = (): StackFrame | undefined =>\n  stackTrace\n    .get()\n    .find(\n      (callSite) =>\n        callSite &&\n        callSite.getFileName() &&\n        !callSite.getFileName().includes(contentEngineLocation) &&\n        !callSite.getFileName().includes(reduxLocation) &&\n        !callSite.getFileName().includes(reduxThunkLocation) &&\n        !isNodeInternalModulePath(callSite.getFileName()),\n    );\n\ninterface ICodeFrame {\n  fileName: string;\n  line: number;\n  column: number;\n  codeFrame: string;\n}\n\nexport const getNonGatsbyCodeFrame = ({\n  highlightCode = true,\n  stack,\n}: {\n  highlightCode?: boolean;\n  stack?: string;\n} = {}): null | ICodeFrame => {\n  let callSite;\n  if (stack) {\n    callSite = stackTrace.parse({ stack, name: ``, message: `` })[0];\n  } else {\n    callSite = getNonGatsbyCallSite();\n  }\n\n  if (!callSite) {\n    return null;\n  }\n\n  const fileName = callSite.getFileName();\n  const line = callSite.getLineNumber();\n  const column = callSite.getColumnNumber();\n\n  const code = fs.readFileSync(fileName, { encoding: `utf-8` });\n  return {\n    fileName,\n    line,\n    column,\n    codeFrame: codeFrameColumns(\n      code,\n      {\n        start: {\n          line,\n          column,\n        },\n      },\n      {\n        highlightCode,\n      },\n    ),\n  };\n};\n\nexport const getNonGatsbyCodeFrameFormatted = ({\n  highlightCode = true,\n  stack,\n}: {\n  highlightCode?: boolean;\n  stack?: string;\n} = {}): null | string => {\n  const possibleCodeFrame = getNonGatsbyCodeFrame({\n    highlightCode,\n    stack,\n  });\n\n  if (!possibleCodeFrame) {\n    return null;\n  }\n\n  const { fileName, line, column, codeFrame } = possibleCodeFrame;\n  return `File ${chalk.bold(`${fileName}:${line}:${column}`)}\\n${codeFrame}`;\n};\n\ninterface IOriginalSourcePositionAndContent {\n  sourcePosition: OriginalMapping | null;\n  sourceContent: string | null;\n}\n\nexport function findOriginalSourcePositionAndContent(\n  webpackSource: SourceMapInput | string,\n  position: { line: number; column: number | null },\n): IOriginalSourcePositionAndContent {\n  const tracer = new TraceMap(webpackSource);\n  const sourcePosition = originalPositionFor(tracer, {\n    line: position.line,\n    column: position.column ?? 0,\n  });\n\n  if (!sourcePosition.source) {\n    return {\n      sourcePosition: null,\n      sourceContent: null,\n    };\n  }\n\n  const sourceContent = sourceContentFor(tracer, sourcePosition.source);\n\n  return {\n    sourcePosition,\n    sourceContent,\n  };\n}\n"],"mappings":"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"}