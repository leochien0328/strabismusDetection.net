{"version":3,"file":"mutex.js","names":["_getStorage","require","DEFAULT_MUTEX_INTERVAL","waitUntilUnlocked","storage","key","timeout","isUnlocked","mutex","ifNoExists","put","LockStatus","Locked","Promise","resolve","setTimeout","createMutex","_global$__GATSBY$buil","_global$__GATSBY","getStorage","getDatabaseDir","BUILD_ID","global","__GATSBY","buildId","prefixedKey","acquire","release","remove","releaseAllMutexes","clearAsync"],"sources":["../../src/core-utils/mutex.ts"],"sourcesContent":["import { getStorage, LockStatus, getDatabaseDir } from \"./utils/get-storage\";\n\ninterface IMutex {\n  acquire(): Promise<void>;\n  release(): Promise<void>;\n}\n\n// Random number to re-check if mutex got released\nconst DEFAULT_MUTEX_INTERVAL = 3000;\n\nasync function waitUntilUnlocked(\n  storage: ReturnType<typeof getStorage>,\n  key: string,\n  timeout: number,\n): Promise<void> {\n  const isUnlocked = await storage.mutex.ifNoExists(key, () => {\n    storage.mutex.put(key, LockStatus.Locked);\n  });\n\n  if (isUnlocked) {\n    return;\n  }\n\n  await new Promise<void>((resolve) => {\n    setTimeout(() => {\n      resolve(waitUntilUnlocked(storage, key, timeout));\n    }, timeout);\n  });\n}\n\n/**\n * Creates a mutex, make sure to call `release` when you're done with it.\n *\n * @param {string} key A unique key\n */\nexport function createMutex(\n  key: string,\n  timeout = DEFAULT_MUTEX_INTERVAL,\n): IMutex {\n  const storage = getStorage(getDatabaseDir());\n  const BUILD_ID = global.__GATSBY?.buildId ?? ``;\n  const prefixedKey = `${BUILD_ID}-${key}`;\n\n  return {\n    acquire: (): Promise<void> =>\n      waitUntilUnlocked(storage, prefixedKey, timeout),\n    release: async (): Promise<void> => {\n      await storage.mutex.remove(prefixedKey);\n    },\n  };\n}\n\nexport async function releaseAllMutexes(): Promise<void> {\n  const storage = getStorage(getDatabaseDir());\n\n  await storage.mutex.clearAsync();\n}\n"],"mappings":";;;;;AAAA,IAAAA,WAAA,GAAAC,OAAA;AAOA;AACA,MAAMC,sBAAsB,GAAG,IAAI;AAEnC,eAAeC,iBAAiBA,CAC9BC,OAAsC,EACtCC,GAAW,EACXC,OAAe,EACA;EACf,MAAMC,UAAU,GAAG,MAAMH,OAAO,CAACI,KAAK,CAACC,UAAU,CAACJ,GAAG,EAAE,MAAM;IAC3DD,OAAO,CAACI,KAAK,CAACE,GAAG,CAACL,GAAG,EAAEM,sBAAU,CAACC,MAAM,CAAC;EAC3C,CAAC,CAAC;EAEF,IAAIL,UAAU,EAAE;IACd;EACF;EAEA,MAAM,IAAIM,OAAO,CAAQC,OAAO,IAAK;IACnCC,UAAU,CAAC,MAAM;MACfD,OAAO,CAACX,iBAAiB,CAACC,OAAO,EAAEC,GAAG,EAAEC,OAAO,CAAC,CAAC;IACnD,CAAC,EAAEA,OAAO,CAAC;EACb,CAAC,CAAC;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACO,SAASU,WAAWA,CACzBX,GAAW,EACXC,OAAO,GAAGJ,sBAAsB,EACxB;EAAA,IAAAe,qBAAA,EAAAC,gBAAA;EACR,MAAMd,OAAO,GAAG,IAAAe,sBAAU,EAAC,IAAAC,0BAAc,EAAC,CAAC,CAAC;EAC5C,MAAMC,QAAQ,IAAAJ,qBAAA,IAAAC,gBAAA,GAAGI,MAAM,CAACC,QAAQ,cAAAL,gBAAA,uBAAfA,gBAAA,CAAiBM,OAAO,cAAAP,qBAAA,cAAAA,qBAAA,GAAK,EAAC;EAC/C,MAAMQ,WAAW,GAAI,GAAEJ,QAAS,IAAGhB,GAAI,EAAC;EAExC,OAAO;IACLqB,OAAO,EAAEA,CAAA,KACPvB,iBAAiB,CAACC,OAAO,EAAEqB,WAAW,EAAEnB,OAAO,CAAC;IAClDqB,OAAO,EAAE,MAAAA,CAAA,KAA2B;MAClC,MAAMvB,OAAO,CAACI,KAAK,CAACoB,MAAM,CAACH,WAAW,CAAC;IACzC;EACF,CAAC;AACH;AAEO,eAAeI,iBAAiBA,CAAA,EAAkB;EACvD,MAAMzB,OAAO,GAAG,IAAAe,sBAAU,EAAC,IAAAC,0BAAc,EAAC,CAAC,CAAC;EAE5C,MAAMhB,OAAO,CAACI,KAAK,CAACsB,UAAU,CAAC,CAAC;AAClC"}