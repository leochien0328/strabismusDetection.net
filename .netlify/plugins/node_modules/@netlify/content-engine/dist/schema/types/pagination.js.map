{"version":3,"file":"pagination.js","names":["_graphqlCompose","require","_derivedTypes","_resolvers","_utils","_sort","getPageInfo","schemaComposer","getOrCreateOTC","tc","addFields","currentPage","hasPreviousPage","hasNextPage","itemCount","pageCount","perPage","totalCount","exports","getEdge","typeComposer","typeName","getTypeName","addDerivedType","derivedTypeName","next","node","getTypeNonNull","previous","getGroup","fields","field","fieldValue","createPagination","getPagination","getFieldSelectorTC","convertToNestedInputType","onEnter","fieldName","sortable","UnionTypeComposer","ScalarTypeComposer","undefined","getFieldExtension","SORTABLE_ENUM","NOT_SORTABLE","DEPRECATED_SORTABLE","deprecationReason","leafInputComposer","getOrCreateETC","etc","setFields","SELECT","value","postfix","fieldTC","paginationTypeComposer","aggregationFields","distinct","type","args","resolve","createDistinctResolver","max","createMaxResolver","min","createMinResolver","sum","createSumResolver","group","skip","limit","createGroupResolver","edges","nodes","pageInfo","makeFieldNonNull"],"sources":["../../../src/schema/types/pagination.ts"],"sourcesContent":["import {\n  SchemaComposer,\n  ObjectTypeComposer,\n  // InputTypeComposer,\n  InterfaceTypeComposer,\n  ObjectTypeComposerFieldConfigMapDefinition,\n  UnionTypeComposer,\n  ScalarTypeComposer,\n  AnyTypeComposer,\n} from \"graphql-compose\";\n// import { getFieldsEnum } from \"./sort\"\nimport { addDerivedType } from \"./derived-types\";\nimport {\n  createDistinctResolver,\n  createGroupResolver,\n  createMaxResolver,\n  createMinResolver,\n  createSumResolver,\n} from \"../resolvers\";\nimport { convertToNestedInputType, IVisitContext } from \"./utils\";\nimport { SORTABLE_ENUM } from \"./sort\";\n\nexport const getPageInfo = <TContext = any>({\n  schemaComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>;\n}): ObjectTypeComposer =>\n  schemaComposer.getOrCreateOTC(`PageInfo`, (tc) => {\n    tc.addFields({\n      currentPage: `Int!`,\n      hasPreviousPage: `Boolean!`,\n      hasNextPage: `Boolean!`,\n      itemCount: `Int!`,\n      pageCount: `Int!`,\n      perPage: `Int`,\n      totalCount: `Int!`,\n    });\n  });\n\nexport const getEdge = <TContext = any>({\n  schemaComposer,\n  typeComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>;\n  typeComposer: ObjectTypeComposer | InterfaceTypeComposer;\n}): ObjectTypeComposer => {\n  const typeName = `${typeComposer.getTypeName()}Edge`;\n  addDerivedType({ typeComposer, derivedTypeName: typeName });\n  return schemaComposer.getOrCreateOTC(typeName, (tc) => {\n    tc.addFields({\n      next: typeComposer,\n      node: typeComposer.getTypeNonNull(),\n      previous: typeComposer,\n    });\n  });\n};\n\nexport const getGroup = <TContext = any>({\n  schemaComposer,\n  typeComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>;\n  typeComposer: ObjectTypeComposer | InterfaceTypeComposer;\n}): ObjectTypeComposer => {\n  const typeName = `${typeComposer.getTypeName()}GroupConnection`;\n  const fields = {\n    field: `String!`,\n    fieldValue: `String`,\n  };\n  return createPagination({ schemaComposer, typeComposer, typeName, fields });\n};\n\nexport const getPagination = <TContext = any>({\n  schemaComposer,\n  typeComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>;\n  typeComposer: ObjectTypeComposer | InterfaceTypeComposer;\n}): ObjectTypeComposer => {\n  const typeName = `${typeComposer.getTypeName()}Connection`;\n  return createPagination({ schemaComposer, typeComposer, typeName });\n};\n\nfunction getFieldSelectorTC({\n  schemaComposer,\n  typeComposer,\n}: {\n  schemaComposer: SchemaComposer<any>;\n  typeComposer: ObjectTypeComposer | InterfaceTypeComposer;\n}): AnyTypeComposer<any> {\n  return convertToNestedInputType({\n    schemaComposer,\n    typeComposer,\n    onEnter: ({ fieldName, typeComposer }): IVisitContext => {\n      const sortable =\n        typeComposer instanceof UnionTypeComposer ||\n        typeComposer instanceof ScalarTypeComposer\n          ? undefined\n          : typeComposer.getFieldExtension(fieldName, `sortable`);\n      if (sortable === SORTABLE_ENUM.NOT_SORTABLE) {\n        // stop traversing\n        return null;\n      } else if (sortable === SORTABLE_ENUM.DEPRECATED_SORTABLE) {\n        // mark this and all nested fields as deprecated\n        return {\n          deprecationReason: `Sorting on fields that need arguments to resolve is deprecated.`,\n        };\n      }\n\n      // continue\n      return undefined;\n    },\n    leafInputComposer: schemaComposer.getOrCreateETC(\n      `FieldSelectorEnum`,\n      (etc) => {\n        etc.setFields({\n          // GraphQL spec doesn't allow using \"true\" (or \"false\" or \"null\") as enum values\n          // so we \"SELECT\"\n          SELECT: { value: `SELECT` },\n        });\n      },\n    ),\n    postfix: `FieldSelector`,\n  }).getTypeNonNull();\n}\n\nfunction createPagination<TSource = any, TContext = any>({\n  schemaComposer,\n  typeComposer,\n  fields,\n  typeName,\n}: {\n  schemaComposer: SchemaComposer<TContext>;\n  typeComposer: ObjectTypeComposer | InterfaceTypeComposer;\n  typeName: string;\n  fields?: ObjectTypeComposerFieldConfigMapDefinition<TSource, TContext>;\n}): ObjectTypeComposer {\n  const fieldTC = getFieldSelectorTC({ schemaComposer, typeComposer });\n\n  const paginationTypeComposer: ObjectTypeComposer =\n    schemaComposer.getOrCreateOTC(typeName, (tc) => {\n      // getGroup() will create a recursive call to pagination,\n      // so only add it and other aggregate functions on onCreate.\n      // Cast into their own category to avoid Typescript conflicts.\n      const aggregationFields: { [key: string]: any } = {\n        distinct: {\n          type: [`String!`],\n          args: {\n            field: fieldTC,\n          },\n          resolve: createDistinctResolver(typeComposer.getTypeName()),\n        },\n        max: {\n          type: `Float`,\n          args: {\n            field: fieldTC,\n          },\n          resolve: createMaxResolver(typeComposer.getTypeName()),\n        },\n        min: {\n          type: `Float`,\n          args: {\n            field: fieldTC,\n          },\n          resolve: createMinResolver(typeComposer.getTypeName()),\n        },\n        sum: {\n          type: `Float`,\n          args: {\n            field: fieldTC,\n          },\n          resolve: createSumResolver(typeComposer.getTypeName()),\n        },\n        group: {\n          type: [getGroup({ schemaComposer, typeComposer }).getTypeNonNull()],\n          args: {\n            skip: `Int`,\n            limit: `Int`,\n            field: fieldTC,\n          },\n          resolve: createGroupResolver(typeComposer.getTypeName()),\n        },\n      };\n\n      tc.addFields({\n        totalCount: `Int!`,\n        edges: [getEdge({ schemaComposer, typeComposer }).getTypeNonNull()],\n        nodes: [typeComposer.getTypeNonNull()],\n        pageInfo: getPageInfo({ schemaComposer }).getTypeNonNull(),\n        ...aggregationFields,\n        ...fields,\n      });\n    });\n  paginationTypeComposer.makeFieldNonNull(`edges`);\n  paginationTypeComposer.makeFieldNonNull(`nodes`);\n  paginationTypeComposer.makeFieldNonNull(`distinct`);\n  paginationTypeComposer.makeFieldNonNull(`group`);\n  addDerivedType({ typeComposer, derivedTypeName: typeName });\n  return paginationTypeComposer;\n}\n"],"mappings":"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"}