{"version":3,"file":"index.js","names":["frameworkHooks","exports","startup","before","after","sourceNodes","customizeSchema","buildSchema","sync","globalState","context","process","on","msg","type","makeInvertedPromise","res","rej","promise","Promise","resolve","reject","setFrameworkHook","name","fn","Error","defaultHookState","userPromise","hookState","runAPI","catch","err","_hookState$before$rej","_hookState$before","call"],"sources":["../../src/framework-hooks/index.ts"],"sourcesContent":["interface InternalHooks {\n  before: () => Promise<void>;\n  after: () => Promise<void>;\n}\n\nexport const frameworkHooks: {\n  startup: InternalHooks;\n  sourceNodes: InternalHooks;\n  customizeSchema: InternalHooks;\n  buildSchema: InternalHooks;\n  sync: InternalHooks;\n} = {\n  startup: {\n    before: async () => {},\n    after: async () => {},\n  },\n  sourceNodes: {\n    before: async () => {},\n    after: async () => {},\n  },\n  customizeSchema: {\n    before: async () => {},\n    after: async () => {},\n  },\n  buildSchema: {\n    before: async () => {},\n    after: async () => {},\n  },\n  sync: {\n    before: async () => {},\n    after: async () => {},\n  },\n};\nexport interface FrameworkContext {\n  [key: string]: unknown;\n}\ntype HookFn = (args: {\n  runAPI: () => Promise<unknown>;\n  context: FrameworkContext;\n}) => Promise<void>;\n\nconst globalState = {\n  context: {},\n};\n\nprocess.on(\n  `message`,\n  (msg: { type: string; context?: Record<string, unknown> | undefined }) => {\n    if (msg?.type === `CONTENT_ENGINE_FRAMEWORK_CONTEXT`) {\n      globalState.context = msg.context || {};\n    }\n  },\n);\n\nfunction makeInvertedPromise() {\n  let res: null | ((value: unknown) => void) = null;\n  let rej: null | ((value: unknown) => void) = null;\n\n  const promise = new Promise((resolve, reject) => {\n    res = resolve;\n    rej = reject;\n  });\n\n  return {\n    promise,\n    resolve: res,\n    reject: rej,\n  };\n}\n\nexport function setFrameworkHook(\n  name: keyof typeof frameworkHooks,\n  fn: HookFn,\n) {\n  if (typeof fn !== `function`) {\n    throw new Error(`Framework hook must be a function`);\n  }\n\n  if (!frameworkHooks[name]) {\n    throw new Error(`Framework hook \"${name}\" does not exist`);\n  }\n\n  interface HookState {\n    resolve: null | ((value: unknown) => void);\n    reject: null | ((value: unknown) => void);\n    promise: null | Promise<unknown>;\n  }\n\n  const defaultHookState: {\n    before: HookState;\n    after: HookState;\n    userPromise: null | Promise<void>;\n  } = {\n    before: {\n      resolve: null,\n      reject: null,\n      promise: null,\n    },\n    after: {\n      resolve: null,\n      reject: null,\n      promise: null,\n    },\n    userPromise: null,\n  };\n\n  const hookState = {\n    ...defaultHookState,\n  };\n\n  function runAPI() {\n    if (hookState.before.resolve) {\n      hookState.before.resolve(null);\n    }\n\n    return hookState.after.promise || Promise.resolve();\n  }\n\n  frameworkHooks[name].before = async () => {\n    try {\n      if (!hookState.before.promise) {\n        hookState.before = makeInvertedPromise();\n        hookState.after = makeInvertedPromise();\n      } else {\n        throw new Error(\n          `Framework hook \"${name}\" is already running. This is a bug or you're calling engine.sync() multiple times at once. Hooks may only run one a time.`,\n        );\n      }\n\n      hookState.userPromise = fn({\n        runAPI,\n        context: globalState.context,\n      }).catch((err) => {\n        hookState.before.reject?.(err);\n        throw err;\n      });\n\n      await hookState.before.promise;\n    } finally {\n      hookState.before = {\n        ...defaultHookState.before,\n      };\n    }\n  };\n\n  frameworkHooks[name].after = async () => {\n    try {\n      if (hookState.after.resolve) {\n        hookState.after.resolve(null);\n      }\n\n      if (hookState.userPromise) {\n        await hookState.userPromise;\n      }\n    } finally {\n      hookState.userPromise = null;\n      hookState.after = {\n        ...defaultHookState.after,\n      };\n    }\n  };\n}\n"],"mappings":"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"}