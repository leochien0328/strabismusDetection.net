{"version":3,"file":"resolve-module-exports.js","names":["fs","_interopRequireWildcard","require","t","_traverse","_interopRequireDefault","_codeFrame","_reporter","_babelParseToAst","_testImportError","_moduleResolver","_resolveJsFilePath","_preferDefault","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","staticallyAnalyzeExports","modulePath","resolver","resolveModule","absPath","exportNames","err","code","readFileSync","ast","babelParseToAst","SyntaxError","codeFrame","codeFrameColumns","start","loc","highlightCode","report","panic","message","isCommonJS","isES6","traverse","ImportDeclaration","ExportNamedDeclaration","astPath","_declaration$declarat","_declaration$id","declaration","node","type","declarations","id","push","name","ExportSpecifier","_astPath$node","exp","exported","exportName","ExportDefaultDeclaration","isIdentifier","isArrowFunctionExpression","isFunctionDeclaration","AssignmentExpression","nodeLeft","left","isMemberExpression","property","object","process","env","NODE_ENV","resolveModuleExports","mode","rootDir","cwd","moduleFilePath","resolveJSFilepath","filePath","maybeAddFileProtocol","rawImportedModule","importedModule","preferDefault","keys","filter","error","testImportError"],"sources":["../../src/bootstrap/resolve-module-exports.ts"],"sourcesContent":["import * as fs from \"fs-extra\";\nimport * as t from \"@babel/types\";\nimport traverse from \"@babel/traverse\";\nimport { codeFrameColumns, SourceLocation } from \"@babel/code-frame\";\nimport report from \"../reporter\";\nimport { babelParseToAst } from \"../utils/babel-parse-to-ast\";\nimport { testImportError } from \"../utils/test-import-error\";\nimport { resolveModule, ModuleResolver } from \"../utils/module-resolver\";\nimport {\n  maybeAddFileProtocol,\n  resolveJSFilepath,\n} from \"./resolve-js-file-path\";\nimport { preferDefault } from \"./prefer-default\";\n\nconst staticallyAnalyzeExports = (\n  modulePath: string,\n  resolver = resolveModule,\n): Array<string> => {\n  let absPath: string | undefined;\n  const exportNames: Array<string> = [];\n\n  try {\n    absPath = resolver(modulePath) as string;\n  } catch (err) {\n    return exportNames; // doesn't exist\n  }\n  const code = fs.readFileSync(absPath, `utf8`); // get file contents\n\n  let ast;\n  try {\n    ast = babelParseToAst(code, absPath);\n  } catch (err) {\n    if (err instanceof SyntaxError) {\n      // Pretty print syntax errors\n      const codeFrame = codeFrameColumns(\n        code,\n        {\n          start: (err as unknown as { loc: SourceLocation[\"start\"] }).loc,\n        },\n        {\n          highlightCode: true,\n        },\n      );\n\n      report.panic(\n        `Syntax error in \"${absPath}\":\\n${err.message}\\n${codeFrame}`,\n      );\n    } else {\n      // if it's not syntax error, just throw it\n      throw err;\n    }\n  }\n\n  let isCommonJS = false;\n  let isES6 = false;\n\n  // extract names of exports from file\n  traverse(ast, {\n    // Check if the file is using ES6 imports\n    ImportDeclaration: function ImportDeclaration() {\n      isES6 = true;\n    },\n\n    ExportNamedDeclaration: function ExportNamedDeclaration(astPath) {\n      const declaration = astPath.node.declaration;\n\n      // get foo from `export const foo = bar`\n      if (\n        declaration?.type === `VariableDeclaration` &&\n        declaration.declarations[0]?.id.type === `Identifier`\n      ) {\n        isES6 = true;\n        exportNames.push(declaration.declarations[0].id.name);\n      }\n\n      // get foo from `export function foo()`\n      if (\n        declaration?.type === `FunctionDeclaration` &&\n        declaration.id?.type === `Identifier`\n      ) {\n        isES6 = true;\n        exportNames.push(declaration.id.name);\n      }\n    },\n\n    // get foo from `export { foo } from 'bar'`\n    // get foo from `export { foo }`\n    ExportSpecifier: function ExportSpecifier(astPath) {\n      isES6 = true;\n      const exp = astPath?.node?.exported;\n      if (!exp) {\n        return;\n      }\n      if (exp.type === `Identifier`) {\n        const exportName = exp.name;\n        if (exportName) {\n          exportNames.push(exportName);\n        }\n      }\n    },\n\n    // export default () => {}\n    // export default function() {}\n    // export default function foo() {}\n    // const foo = () => {}; export default foo\n    ExportDefaultDeclaration: function ExportDefaultDeclaration(astPath) {\n      const declaration = astPath.node.declaration;\n      if (\n        !t.isIdentifier(declaration) &&\n        !t.isArrowFunctionExpression(declaration) &&\n        !t.isFunctionDeclaration(declaration)\n      ) {\n        return;\n      }\n\n      let name = ``;\n      if (t.isIdentifier(declaration)) {\n        name = declaration.name;\n      } else if (t.isFunctionDeclaration(declaration) && declaration.id) {\n        name = declaration.id.name;\n      }\n\n      const exportName = `export default${name ? ` ${name}` : ``}`;\n      isES6 = true;\n      exportNames.push(exportName);\n    },\n\n    AssignmentExpression: function AssignmentExpression(astPath) {\n      const nodeLeft = astPath.node.left;\n\n      if (!t.isMemberExpression(nodeLeft)) {\n        return;\n      }\n\n      // ignore marker property `__esModule`\n      if (\n        t.isIdentifier(nodeLeft.property) &&\n        nodeLeft.property.name === `__esModule`\n      ) {\n        return;\n      }\n\n      // get foo from `exports.foo = bar`\n      if (\n        t.isIdentifier(nodeLeft.object) &&\n        nodeLeft.object.name === `exports`\n      ) {\n        isCommonJS = true;\n        exportNames.push((nodeLeft.property as t.Identifier).name);\n      }\n\n      // get foo from `module.exports.foo = bar`\n      if (t.isMemberExpression(nodeLeft.object)) {\n        const exp: t.MemberExpression = nodeLeft.object;\n\n        if (\n          t.isIdentifier(exp.object) &&\n          t.isIdentifier(exp.property) &&\n          exp.object.name === `module` &&\n          exp.property.name === `exports`\n        ) {\n          isCommonJS = true;\n          exportNames.push((nodeLeft.property as t.Identifier).name);\n        }\n      }\n    },\n  });\n\n  if (isES6 && isCommonJS && process.env.NODE_ENV !== `test`) {\n    report.panic(\n      `This plugin file is using both CommonJS and ES6 module systems together which we don't support.\nYou'll need to edit the file to use just one or the other.\n\nplugin: ${modulePath}.js\n\nThis didn't cause a problem in Gatsby v1 so you might want to review the migration doc for this:\nhttps://gatsby.dev/no-mixed-modules\n      `,\n    );\n  }\n  return exportNames;\n};\n\ninterface IResolveModuleExportsOptions {\n  mode?: `analysis` | `import`;\n  resolver?: ModuleResolver;\n  rootDir?: string;\n}\n\n/**\n * Given a path to a module, return an array of the module's exports.\n *\n * It can run in two modes:\n * 1. `analysis` mode gets exports via static analysis by traversing the file's AST with babel\n * 2. `import` mode gets exports by directly importing the module and accessing its properties\n *\n * At the time of writing, analysis mode is used for files that can be jsx (e.g. gatsby-browser, gatsby-ssr)\n * and import mode is used for files that can be js or mjs.\n *\n * Returns [] for invalid paths and modules without exports.\n */\nexport async function resolveModuleExports(\n  modulePath: string,\n  {\n    mode = `analysis`,\n    resolver = resolveModule,\n    rootDir = process.cwd(),\n  }: IResolveModuleExportsOptions = {},\n): Promise<Array<string>> {\n  if (mode === `import`) {\n    try {\n      const moduleFilePath = await resolveJSFilepath({\n        rootDir,\n        filePath: modulePath,\n      });\n\n      if (!moduleFilePath) {\n        return [];\n      }\n\n      const filePath = maybeAddFileProtocol(moduleFilePath);\n      const rawImportedModule = await import(filePath);\n\n      // If the module is cjs, the properties we care about are nested under a top-level `default` property\n      const importedModule = preferDefault(rawImportedModule);\n\n      return Object.keys(importedModule).filter(\n        (exportName) => exportName !== `__esModule`,\n      );\n    } catch (error) {\n      if (!testImportError(modulePath, error)) {\n        // if module exists, but requiring it cause errors,\n        // show the error to the user and terminate build\n        report.panic(`Error in \"${modulePath}\":`, error);\n      }\n    }\n  } else {\n    return staticallyAnalyzeExports(modulePath, resolver);\n  }\n\n  return [];\n}\n"],"mappings":"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"}