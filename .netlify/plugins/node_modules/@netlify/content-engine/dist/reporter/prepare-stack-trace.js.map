{"version":3,"file":"prepare-stack-trace.js","names":["_fs","require","_codeFrame","_stackTrace","_interopRequireDefault","_traceMapping","path","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","ErrorWithCodeFrame","Error","codeFrame","constructor","error","message","getOwnPropertyNames","forEach","exports","prepareStackTrace","sourceOfMainMap","newError","bundleDir","dirname","bundleDirMapFiles","readdirSync","filter","fileName","endsWith","map","join","maps","source","TraceMap","readFileSync","stack","stackTrace","parse","frame","wrapCallSite","getFileName","match","getErrorSource","name","topFrame","sourceContentFor","codeFrameColumns","start","line","getLineNumber","column","getColumnNumber","highlightCode","position","getPosition","getScriptNameOrSourceURL","toString","CallSiteToString","wasConverted","includes","slice","indexOf","replace","test","originalPositionFor","_this","self","fileLocation","isNative","isEval","getEvalOrigin","lineNumber","columnNumber","functionName","getFunctionName","addSuffix","isConstructor","methodName","getMethodName","typeName","getTypeName","isMethodCall","isToplevel","length"],"sources":["../../src/reporter/prepare-stack-trace.ts"],"sourcesContent":["/* Code borrowed and based on\n * https://github.com/evanw/node-source-map-support/blob/master/source-map-support.js\n */\n\nimport { readFileSync, readdirSync } from \"fs\";\nimport { codeFrameColumns } from \"@babel/code-frame\";\nimport stackTrace from \"stack-trace\";\nimport {\n  TraceMap,\n  originalPositionFor,\n  OriginalMapping,\n  InvalidOriginalMapping,\n  sourceContentFor,\n} from \"@jridgewell/trace-mapping\";\nimport * as path from \"path\";\n\nexport class ErrorWithCodeFrame extends Error {\n  codeFrame?: string = ``;\n\n  constructor(error: Error) {\n    super(error.message);\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach((key) => {\n      this[key] = error[key];\n    });\n  }\n}\n\nexport function prepareStackTrace(\n  error: Error,\n  sourceOfMainMap: string,\n): ErrorWithCodeFrame {\n  const newError = new ErrorWithCodeFrame(error);\n  // source point to single map, but with code splitting for build-html we need to handle more maps\n  // we use fact that all .map files will be in same dir as main one here\n  const bundleDir = path.dirname(sourceOfMainMap);\n  const bundleDirMapFiles = readdirSync(bundleDir)\n    .filter((fileName) => fileName.endsWith(`.js.map`))\n    .map((fileName) => path.join(bundleDir, fileName));\n\n  const maps = bundleDirMapFiles.map(\n    (source) => new TraceMap(readFileSync(source, `utf8`)),\n  );\n\n  const stack = stackTrace\n    .parse(newError)\n    .map((frame) => wrapCallSite(maps, frame))\n    .filter(\n      (frame) =>\n        `wasConverted` in frame &&\n        (!frame.getFileName() ||\n          !frame\n            .getFileName()\n            .match(/^webpack:\\/+(lib\\/)?(webpack\\/|\\.cache\\/)/)),\n    );\n\n  newError.codeFrame = getErrorSource(maps, stack[0]);\n  newError.stack =\n    `${newError.name}: ${newError.message}\\n` +\n    stack.map((frame) => `    at ${frame}`).join(`\\n`);\n\n  return newError;\n}\n\nfunction getErrorSource(\n  maps: Array<TraceMap>,\n  topFrame: stackTrace.StackFrame | IWrappedStackFrame,\n): string {\n  let source;\n  for (const map of maps) {\n    source = sourceContentFor(map, topFrame.getFileName());\n    if (source) {\n      break;\n    }\n  }\n\n  return source\n    ? codeFrameColumns(\n        source,\n        {\n          start: {\n            line: topFrame.getLineNumber(),\n            column: topFrame.getColumnNumber(),\n          },\n        },\n        {\n          highlightCode: true,\n        },\n      )\n    : ``;\n}\n\ninterface IWrappedStackFrame {\n  getFileName(): string;\n  getLineNumber(): number;\n  getColumnNumber(): number;\n  getScriptNameOrSourceURL(): string;\n  toString: typeof CallSiteToString;\n  wasConverted: true;\n}\n\nfunction wrapCallSite(\n  maps: Array<TraceMap>,\n  frame: stackTrace.StackFrame,\n): IWrappedStackFrame | stackTrace.StackFrame {\n  const source = frame.getFileName();\n  if (!source) return frame;\n\n  const position = getPosition({ maps, frame });\n  if (!position.source) return frame;\n\n  return {\n    getFileName: (): string => position.source || ``,\n    getLineNumber: (): number => position.line || 0,\n    getColumnNumber: (): number => (position.column || 0) + 1,\n    getScriptNameOrSourceURL: (): string => position.source || ``,\n    toString: CallSiteToString,\n    wasConverted: true,\n  };\n}\n\nfunction getPosition({\n  maps,\n  frame,\n}: {\n  maps: Array<TraceMap>;\n  frame: stackTrace.StackFrame;\n}): OriginalMapping | InvalidOriginalMapping {\n  if (frame.getFileName().includes(`webpack:`)) {\n    // if source-map-register is initiated, stack traces would already be converted\n    return {\n      column: frame.getColumnNumber() - 1,\n      line: frame.getLineNumber(),\n      source: frame\n        .getFileName()\n        .slice(frame.getFileName().indexOf(`webpack:`))\n        .replace(/webpack:\\/+/g, `webpack://`),\n      name: null,\n    };\n  }\n\n  const line = frame.getLineNumber();\n  const column = frame.getColumnNumber();\n  for (const map of maps) {\n    const test = originalPositionFor(map, { line, column });\n    if (test.source) {\n      return test;\n    }\n  }\n\n  return { source: null, column: null, line: null, name: null };\n}\n\n// This is copied almost verbatim from the V8 source code at\n// https://code.google.com/p/v8/source/browse/trunk/src/messages.js.\nfunction CallSiteToString(): string {\n  // @ts-ignore\n  const _this = this; // eslint-disable-line @typescript-eslint/no-this-alias\n  const self = _this as\n    | NodeJS.CallSite\n    | IWrappedStackFrame\n    | stackTrace.StackFrame;\n\n  let fileName;\n  let fileLocation = ``;\n  if (`isNative` in self && self.isNative()) {\n    fileLocation = `native`;\n  } else {\n    fileName =\n      (`getScriptNameOrSourceURL` in self && self.getScriptNameOrSourceURL()) ||\n      (`getFileName` in self && self.getFileName());\n\n    if (!fileName && `isEval` in self && self.isEval()) {\n      fileLocation = `${self.getEvalOrigin()}, `;\n    }\n\n    if (fileName) {\n      fileLocation += fileName.replace(/^webpack:\\/+(lib\\/)?/, ``);\n    } else {\n      // Source code does not originate from a file and is not native, but we\n      // can still get the source position inside the source string, e.g. in\n      // an eval string.\n      fileLocation += `<anonymous>`;\n    }\n    const lineNumber = `getLineNumber` in self ? self.getLineNumber() : null;\n    if (lineNumber != null) {\n      fileLocation += `:${lineNumber}`;\n      const columnNumber =\n        `getColumnNumber` in self ? self.getColumnNumber() : null;\n      if (columnNumber) {\n        fileLocation += `:${columnNumber}`;\n      }\n    }\n  }\n\n  let line = ``;\n  const functionName = `getFunctionName` in self ? self.getFunctionName() : ``;\n  let addSuffix = true;\n  const isConstructor = `isConstructor` in self && self.isConstructor();\n  const methodName = `getMethodName` in self ? self.getMethodName() : ``;\n  const typeName = `getTypeName` in self ? self.getTypeName() : ``;\n  const isMethodCall =\n    methodName &&\n    !((`isToplevel` in self && self.isToplevel()) || isConstructor);\n  if (isMethodCall && functionName) {\n    if (typeName && functionName.indexOf(typeName) != 0) {\n      line += `${typeName}.`;\n    }\n    line += functionName;\n    if (\n      functionName.indexOf(`.` + methodName) !=\n      functionName.length - (methodName || ``).length - 1\n    ) {\n      line += ` [as ${methodName}]`;\n    }\n  } else if (typeName && !functionName) {\n    line += typeName + `.` + (methodName || `<anonymous>`);\n  } else if (isConstructor) {\n    line += `new ` + (functionName || `<anonymous>`);\n  } else if (functionName) {\n    line += functionName;\n  } else {\n    line += fileLocation;\n    addSuffix = false;\n  }\n  if (addSuffix) line += ` (${fileLocation})`;\n  return line;\n}\n"],"mappings":"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"}